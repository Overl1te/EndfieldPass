{% extends 'base.html' %}
{% load i18n_tags %}

{% block title %}{% t "title.dashboard" %} | EndfieldPass{% endblock %}

{% block content %}
<header class="page-header">
    <h1>{% t "dashboard.title" %}</h1>
    <div class="header-actions">
        <a href="{% url 'import_page' %}" class="btn">{% t "dashboard.action.import" %}</a>
        <a href="{% url 'settings_page' %}" class="btn btn-outline">{% t "dashboard.action.settings" %}</a>
    </div>
</header>

<section class="card-grid dashboard-grid">
    {% for card in cards %}
    <article
        class="wish-card wish-card--history"
        data-history-card
        data-source-pool-type="{{ card.source_pool_type }}"
        data-pool-fallback="{{ card.pool_id_fallback }}"
        data-six-limit="{{ card.six_star_limit }}"
        data-five-limit="{{ card.five_star_limit }}"
        data-empty-text="{% t 'dashboard.empty' %}"
        data-unknown-name="{% t 'characters.unknown_name' %}"
    >
        <div class="wish-card-header">
            <h2>{{ card.title }}</h2>
        </div>

        <div class="stat-row">
            <span class="label">{% t "dashboard.total_wishes" %}</span>
            <span class="value" data-total>{{ card.total }}</span>
        </div>
        <div class="stat-row">
            <div>
                <span class="label">{% t "dashboard.pity6" %}</span>
                <span
                    class="label-sub"
                    data-six-sub
                    data-pity-template="{% t 'dashboard.pity_suffix' limit='__LIMIT__' left='__LEFT__' %}"
                >{% t "dashboard.pity_suffix" limit=card.six_star_limit left=card.six_star_left %}</span>
            </div>
            <span class="value accent-orange" data-six-pity>{{ card.six_star_pity }}</span>
        </div>
        <div class="stat-row">
            <div>
                <span class="label">{% t "dashboard.pity5" %}</span>
                <span
                    class="label-sub"
                    data-five-sub
                    data-pity-template="{% t 'dashboard.pity_suffix' limit='__LIMIT__' left='__LEFT__' %}"
                >{% t "dashboard.pity_suffix" limit=card.five_star_limit left=card.five_star_left %}</span>
            </div>
            <span class="value accent-gold" data-five-pity>{{ card.five_star_pity }}</span>
        </div>

        <div class="wish-history" data-history-body>
            <div class="rarity-pills">
                <button class="rarity-pill active rarity-6" type="button" data-rarity-filter="6">6 ★</button>
                <button class="rarity-pill active rarity-5" type="button" data-rarity-filter="5">5 ★</button>
                <button class="rarity-pill active rarity-4" type="button" data-rarity-filter="4">4 ★</button>
                <button class="rarity-pill active" type="button" data-rarity-filter="all">{% t "dashboard.filter.all" %}</button>
            </div>

            <div class="history-table-wrap">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>{% t "dashboard.table.name" %}</th>
                            <th>{% t "dashboard.table.date" %}</th>
                            <th>{% t "dashboard.table.guarantee" %}</th>
                        </tr>
                    </thead>
                    <tbody data-history-rows>
                        {% for row in card.history_rows %}
                        <tr data-rarity="{{ row.rarity }}">
                            <td class="rarity-{{ row.rarity }}">{{ row.name }}</td>
                            <td>{{ row.date }}</td>
                            <td>{{ row.guarantee }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3">{% t "dashboard.empty" %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <button
            class="history-toggle history-toggle-bottom"
            type="button"
            data-history-toggle
            aria-expanded="true"
            aria-label="{% t 'dashboard.history.collapse' %}"
        >
            <span class="history-toggle-icon" aria-hidden="true">
                <svg viewBox="0 0 20 20" focusable="false">
                    <path d="M4.75 12.5L10 7.25L15.25 12.5"></path>
                </svg>
            </span>
        </button>
    </article>
    {% endfor %}
</section>

<script>
(() => {
    const formatDate = (ts) => {
        const value = Number(ts) || 0;
        if (!value) return "-";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "-";
        return date.toLocaleString();
    };

    const pityCounterUntilAny = (rarities, resetValues) => {
        let counter = 0;
        for (const rarity of rarities) {
            if (resetValues.has(rarity)) return counter;
            counter += 1;
        }
        return counter;
    };

    const pityStateWithResets = (rarities, resetValues, hardLimit) => {
        const current = pityCounterUntilAny(rarities, resetValues);
        return [current, Math.max(hardLimit - current, 0)];
    };

    const renderCardFromPulls = (card, pulls) => {
        const poolType = String(card.dataset.sourcePoolType || "");
        const poolFallback = String(card.dataset.poolFallback || "").toLowerCase();
        const sixLimit = Number.parseInt(card.dataset.sixLimit || "80", 10) || 80;
        const fiveLimit = Number.parseInt(card.dataset.fiveLimit || "10", 10) || 10;
        const emptyText = card.dataset.emptyText || "No data";
        const unknownName = card.dataset.unknownName || "Unknown";

        const relevant = pulls.filter((pull) => {
            const byType = String(pull.source_pool_type || "") === poolType;
            const byFallback = String(pull.pool_id || "").toLowerCase().includes(poolFallback);
            return byType || byFallback;
        }).sort((a, b) => (Number(b.seq_id) || 0) - (Number(a.seq_id) || 0));

        const rarities = relevant.map((pull) => Number(pull.rarity) || 0);
        const [sixPity, sixLeft] = pityStateWithResets(rarities, new Set([6]), sixLimit);
        const [fivePity, fiveLeft] = pityStateWithResets(rarities, new Set([5, 6]), fiveLimit);

        const totalNode = card.querySelector("[data-total]");
        const sixPityNode = card.querySelector("[data-six-pity]");
        const fivePityNode = card.querySelector("[data-five-pity]");
        const sixSubNode = card.querySelector("[data-six-sub]");
        const fiveSubNode = card.querySelector("[data-five-sub]");
        if (totalNode) totalNode.textContent = String(rarities.length);
        if (sixPityNode) sixPityNode.textContent = String(sixPity);
        if (fivePityNode) fivePityNode.textContent = String(fivePity);
        if (sixSubNode) {
            const template = String(sixSubNode.dataset.pityTemplate || "");
            sixSubNode.textContent = template.replace("__LIMIT__", String(sixLimit)).replace("__LEFT__", String(sixLeft));
        }
        if (fiveSubNode) {
            const template = String(fiveSubNode.dataset.pityTemplate || "");
            fiveSubNode.textContent = template.replace("__LIMIT__", String(fiveLimit)).replace("__LEFT__", String(fiveLeft));
        }

        const historyRowsNode = card.querySelector("[data-history-rows]");
        if (!historyRowsNode) return;

        const visiblePulls = relevant.slice(0, 120);
        const chronological = [...visiblePulls].reverse();
        let pity6 = 0;
        let pity5 = 0;
        let pity4 = 0;
        const rows = [];
        chronological.forEach((pull) => {
            const rarity = Number(pull.rarity) || 0;
            pity6 += 1;
            pity5 += 1;
            pity4 += 1;
            let guarantee = pity4;
            if (rarity === 6) {
                guarantee = pity6;
                pity6 = 0;
                pity5 = 0;
                pity4 = 0;
            } else if (rarity === 5) {
                guarantee = pity5;
                pity5 = 0;
                pity4 = 0;
            } else if (rarity === 4) {
                guarantee = pity4;
                pity4 = 0;
            }
            rows.push({
                rarity,
                name: pull.char_name || pull.char_id || unknownName,
                date: formatDate(pull.gacha_ts),
                guarantee,
            });
        });

        const finalRows = rows.reverse();
        if (!finalRows.length) {
            historyRowsNode.innerHTML = `<tr><td colspan="3">${emptyText}</td></tr>`;
            return;
        }
        historyRowsNode.innerHTML = finalRows.map((row) => `
            <tr data-rarity="${row.rarity}">
                <td class="rarity-${row.rarity}">${row.name}</td>
                <td>${row.date}</td>
                <td>${row.guarantee}</td>
            </tr>
        `).join("");
    };

    document.querySelectorAll("[data-history-card]").forEach((card) => {
        const toggle = card.querySelector("[data-history-toggle]");
        const body = card.querySelector("[data-history-body]");
        const pills = card.querySelectorAll("[data-rarity-filter]");
        const collapseLabel = "{% t 'dashboard.history.collapse' %}";
        const expandLabel = "{% t 'dashboard.history.expand' %}";
        const updateToggleLabel = (isExpanded) => {
            toggle.setAttribute("aria-label", isExpanded ? collapseLabel : expandLabel);
        };

        updateToggleLabel(true);

        toggle.addEventListener("click", () => {
            const expanded = toggle.getAttribute("aria-expanded") === "true";
            const nextExpanded = !expanded;
            toggle.setAttribute("aria-expanded", nextExpanded ? "true" : "false");
            body.classList.toggle("collapsed", expanded);
            updateToggleLabel(nextExpanded);
        });

        const allButton = card.querySelector('[data-rarity-filter="all"]');
        const rarityButtons = Array.from(pills).filter((pill) => pill.dataset.rarityFilter !== "all");

        const applyFilters = () => {
            const activeValues = new Set(
                rarityButtons
                    .filter((pill) => pill.classList.contains("active"))
                    .map((pill) => pill.dataset.rarityFilter)
            );
            const rows = card.querySelectorAll("tbody tr[data-rarity]");

            if (activeValues.size === 0) {
                rarityButtons.forEach((pill) => pill.classList.add("active"));
                allButton.classList.add("active");
                rows.forEach((row) => {
                    row.hidden = false;
                });
                return;
            }

            const showAll = activeValues.size === rarityButtons.length;
            allButton.classList.toggle("active", showAll);
            rows.forEach((row) => {
                row.hidden = !activeValues.has(row.dataset.rarity);
            });
        };

        rarityButtons.forEach((pill) => {
            pill.addEventListener("click", () => {
                const activeCount = rarityButtons.filter((button) => button.classList.contains("active")).length;
                const allSelected = activeCount === rarityButtons.length;

                if (allSelected) {
                    rarityButtons.forEach((button) => button.classList.toggle("active", button === pill));
                } else {
                    const willBeActive = !pill.classList.contains("active");
                    pill.classList.toggle("active", willBeActive);
                    const hasAnyActive = rarityButtons.some((button) => button.classList.contains("active"));
                    if (!hasAnyActive) {
                        pill.classList.add("active");
                    }
                }
                applyFilters();
            });
        });

        allButton.addEventListener("click", () => {
            const shouldEnableAll = !allButton.classList.contains("active");
            rarityButtons.forEach((pill) => pill.classList.toggle("active", shouldEnableAll));
            allButton.classList.toggle("active", shouldEnableAll);
            applyFilters();
        });

        applyFilters();
    });

    const renderDashboard = () => {
        const historyApi = window.endfieldPassHistory;
        if (!historyApi || typeof historyApi.getLatestPulls !== "function") return;
        const pulls = historyApi.getLatestPulls() || [];
        document.querySelectorAll("[data-history-card]").forEach((card) => {
            renderCardFromPulls(card, pulls);
        });
        document.querySelectorAll("[data-history-card]").forEach((card) => {
            const allButton = card.querySelector('[data-rarity-filter="all"]');
            const rarityButtons = Array.from(card.querySelectorAll("[data-rarity-filter]"))
                .filter((pill) => pill.dataset.rarityFilter !== "all");
            const rows = card.querySelectorAll("tbody tr[data-rarity]");
            const activeValues = new Set(
                rarityButtons
                    .filter((pill) => pill.classList.contains("active"))
                    .map((pill) => pill.dataset.rarityFilter)
            );
            const showAll = activeValues.size === rarityButtons.length;
            if (allButton) allButton.classList.toggle("active", showAll);
            rows.forEach((row) => {
                row.hidden = activeValues.size ? !activeValues.has(row.dataset.rarity) : false;
            });
        });
    };

    const bootDashboard = () => {
        renderDashboard();
        window.addEventListener("endfieldpass:history-updated", renderDashboard);
    };

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", bootDashboard, { once: true });
    } else {
        bootDashboard();
    }
})();
</script>
{% endblock %}
