{% extends 'base.html' %}
{% load i18n_tags static %}

{% block title %}{% t "title.import" %} | EndfieldPass{% endblock %}

{% block content %}
<section
    class="import-page"
    id="importPage"
    data-create-session-url="{% url 'create_session' %}"
    data-status-template="{% url 'import_status' 0 %}"
    data-view-template="{% url 'import_view' 0 %}"
    data-pulls-template="{% url 'pulls_json' 0 %}"
    data-current-session-id="{% if session %}{{ session.id }}{% endif %}"
    data-turnstile-enabled="{% if turnstile_enabled %}true{% else %}false{% endif %}"
>
    <header class="import-header">
        <h1>{% t "import.title" %}</h1>
    </header>

    <article class="import-hero">
        <div class="hero-icon">✦</div>
        <div>
            <h2>{% t "import.hero.title" %}</h2>
            <p>{% t "import.hero.desc" %}</p>
            <p class="hero-warning">{% t "import.hero.warn" %}</p>
        </div>
    </article>

    <div class="import-error" id="importError"{% if not error %} hidden{% endif %}>{{ error }}</div>

    <section class="import-box">
        <form method="post" class="import-form" id="importForm">
            {% csrf_token %}
            <div class="import-mode-switch">
                <button type="button" class="mode-btn active" data-import-mode="auto">{% t "import.mode.auto" %}</button>
                <button type="button" class="mode-btn" data-import-mode="manual">{% t "import.mode.manual" %}</button>
            </div>
            <input type="hidden" id="import_mode" name="import_mode" value="auto">

            <div class="mode-panel" data-mode-panel="auto">
                <label for="page_url">{% t "import.page_url" %}</label>
                <textarea id="page_url" name="page_url" rows="4" placeholder="https://ef-webview.gryphline.com/page/gacha_char?...">{{ form.page_url }}</textarea>
            </div>

            <div class="form-grid mode-panel" data-mode-panel="manual" hidden>
                <div>
                    <label for="token">{% t "import.manual.token" %}</label>
                    <input id="token" name="token" type="text" value="{{ form.token }}" placeholder="{% t 'import.token.placeholder' %}">
                </div>
                <div>
                    <label for="server_id">{% t "import.manual.server_id" %}</label>
                    <select id="server_id" name="server_id">
                        <option value="1" {% if form.server_id == "1" %}selected{% endif %}>1</option>
                        <option value="2" {% if form.server_id == "2" %}selected{% endif %}>2</option>
                        <option value="3" {% if form.server_id == "3" %}selected{% endif %}>3</option>
                        <option value="4" {% if form.server_id == "4" %}selected{% endif %}>4</option>
                    </select>
                </div>
                <div>
                    <label for="lang">{% t "import.manual.language" %}</label>
                    <select id="lang" name="lang">
                        <option value="ru-ru" {% if form.lang == "ru-ru" %}selected{% endif %}>ru-ru</option>
                        <option value="en-us" {% if form.lang == "en-us" %}selected{% endif %}>en-us</option>
                        <option value="ja-jp" {% if form.lang == "ja-jp" %}selected{% endif %}>ja-jp</option>
                    </select>
                </div>
            </div>

            {% if turnstile_enabled and turnstile_site_key %}
            <div class="turnstile-wrap">
                <div
                    class="cf-turnstile"
                    id="turnstileWidget"
                    data-sitekey="{{ turnstile_site_key }}"
                    data-theme="dark"
                    data-size="flexible"
                ></div>
            </div>
            {% endif %}

            <button type="submit" class="btn import-submit" id="importSubmit">{% t "import.run" %}</button>
        </form>
    </section>

    <section class="import-guide">
        <h3>{% t "import.guide.title" %}</h3>
        <div class="platform-switch" role="tablist" aria-label="{% t 'import.platform.aria' %}">
            <button type="button" class="platform-btn active" data-platform-btn="windows" aria-selected="true">{% t "import.platform.windows" %}</button>
            <button type="button" class="platform-btn" data-platform-btn="linux" aria-selected="false">{% t "import.platform.linux" %}</button>
            <button type="button" class="platform-btn" data-platform-btn="android" aria-selected="false">{% t "import.platform.android" %} <span class="platform-beta-badge">{% t "import.platform.beta" %}</span></button>
            <button type="button" class="platform-btn" data-platform-btn="ios" aria-selected="false">{% t "import.platform.ios" %} <span class="platform-beta-badge">{% t "import.platform.beta" %}</span></button>
        </div>

        <div class="platform-panel" data-platform-panel="windows">
            <ol>
                <li>{% t "import.platform.step1" %}</li>
                <li>{% t "import.platform.step2" %}</li>
                <li>{% t "import.platform.step3" %}</li>
                <li>{% t "import.platform.step4" %}</li>
                <li>{% t "import.platform.step5" %}</li>
            </ol>
            <div class="import-script-wrap">
                <pre class="import-script"><code id="powershellScript">iwr https://endfieldpass.site/scripts/endfieldpass.ps1 -UseBasicParsing -OutFile $env:TEMP\endfieldpass.ps1; & powershell -NoProfile -ExecutionPolicy Bypass -File $env:TEMP\endfieldpass.ps1
</code></pre>
                <button type="button" class="btn btn-outline script-copy-btn" data-copy-script-btn data-copy-script-target="powershellScript">{% t "import.copy" %}</button>
            </div>
            <ol start="6">
                <li>{% t "import.platform.step6" %}</li>
                <li>{% t "import.platform.step7" %}</li>
            </ol>
        </div>

        <div class="platform-panel" data-platform-panel="linux" hidden>
            <ol>
                <li>{% t "import.platform.step1" %}</li>
                <li>{% t "import.platform.linux.step2" %}</li>
                <li>{% t "import.platform.step3" %}</li>
                <li>{% t "import.platform.linux.step4" %}</li>
                <li>{% t "import.platform.linux.step5" %}</li>
            </ol>
            <div class="import-script-wrap">
                <pre class="import-script"><code id="linuxScript">curl -fsSL https://endfieldpass.site/scripts/endfieldpass.sh -o "${TMPDIR:-/tmp}/endfieldpass.sh" && chmod +x "${TMPDIR:-/tmp}/endfieldpass.sh" && "${TMPDIR:-/tmp}/endfieldpass.sh"
</code></pre>
                <button type="button" class="btn btn-outline script-copy-btn" data-copy-script-btn data-copy-script-target="linuxScript">{% t "import.copy" %}</button>
            </div>
            <ol start="6">
                <li>{% t "import.platform.step6" %}</li>
                <li>{% t "import.platform.step7" %}</li>
            </ol>
        </div>

        <div class="platform-panel" data-platform-panel="android" hidden>
            <ol>
                <li>{% t "import.platform.android.step1" %}</li>
                <li>{% t "import.platform.android.step2" %}</li>
                <li>{% t "import.platform.android.step3" %}</li>
                <li>{% t "import.platform.android.step4" %}</li>
                <li>{% t "import.platform.android.step5" %}</li>
            </ol>
        </div>

        <div class="platform-panel" data-platform-panel="ios" hidden>
            <ol>
                <li>{% t "import.platform.ios.step1" %}</li>
                <li>{% t "import.platform.ios.step2" %}</li>
                <li>{% t "import.platform.ios.step3" %}</li>
                <li>{% t "import.platform.ios.step4" %}</li>
                <li>{% t "import.platform.ios.step5" %}</li>
                <li>{% t "import.platform.ios.step6" %}</li>
            </ol>
        </div>
    </section>

    {% if session %}
    <section class="import-result">
        <div class="result-meta">
            <h3>{% t "import.result.header" id=session.id %}</h3>
            <p>{% t "import.result.status" status=session.status %}{% if session.error %} | {% t "import.result.error" error=session.error %}{% endif %}</p>
            <p>{% t "import.result.server_lang" server=session.server_id lang=session.lang %}</p>
            <p><a href="{% url 'pulls_json' session.id %}">{% t "import.result.json" %}</a> · <a href="{% url 'pulls_api' %}?session_id={{ session.id }}">{% t "import.result.api" %}</a></p>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>{% t "import.result.table.seq" %}</th>
                        <th>{% t "import.result.table.pool" %}</th>
                        <th>{% t "import.result.table.rarity" %}</th>
                        <th>{% t "import.result.table.name" %}</th>
                        <th>{% t "import.result.table.free" %}</th>
                        <th>{% t "import.result.table.new" %}</th>
                        <th>{% t "import.result.table.ts" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in pulls %}
                    <tr>
                        <td>{{ p.seq_id }}</td>
                        <td>{{ p.pool_id }} ({{ p.pool_name }})</td>
                        <td>{{ p.rarity }}</td>
                        <td>{{ p.char_name }} ({{ p.char_id }})</td>
                        <td>{{ p.is_free }}</td>
                        <td>{{ p.is_new }}</td>
                        <td>{{ p.gacha_ts }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                            <td colspan="7">{% t "import.result.none" %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}
</section>

<div class="loading-modal" id="loadingModal" hidden>
    <div class="import-loading loading-modal-card">
        <div class="loading-gear" aria-hidden="true"></div>
        <div class="loading-top-media-wrap" id="loadingTopMediaWrap" aria-hidden="true">
            <div class="loading-top-media">
                <video
                    class="loading-top-video"
                    autoplay
                    loop
                    muted
                    playsinline
                    preload="auto"
                    onerror="this.hidden=true; this.nextElementSibling.hidden=false;"
                >
                    <source src="{% static 'gif/endmin_moving.webm' %}" type="video/webm">
                </video>
                <img
                    class="loading-top-fallback"
                    src="{% static 'img/logo.png' %}"
                    alt=""
                    loading="eager"
                    hidden
                >
            </div>
        </div>
        <p class="loading-message" id="loadingMessage">{% t "import.loading.prepare" %}</p>
        <p class="loading-hint" id="loadingHint">{% t "import.loading.hint1" %}</p>
        <div class="loading-progress-track" id="loadingProgressTrack" aria-hidden="true">
            <div class="loading-progress-value" id="loadingProgress"></div>
        </div>
        <p class="loading-percent" id="loadingPercent">0%</p>
    </div>
</div>

{% if turnstile_enabled and turnstile_site_key %}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{% endif %}

<script>
(() => {
    const page = document.getElementById("importPage");
    if (!page) return;

    const i18n = {
        loadingPrepare: "{% t 'import.loading.prepare' %}",
        loadingHint1: "{% t 'import.loading.hint1' %}",
        loadingHint2: "{% t 'import.loading.hint2' %}",
        loadingHint3: "{% t 'import.loading.hint3' %}",
        loadingHint4: "{% t 'import.loading.hint4' %}",
        loadingHint5: "{% t 'import.loading.hint5' %}",
        loadingHint6: "{% t 'import.loading.hint6' %}",
        loadingHint7: "{% t 'import.loading.hint7' %}",
        loadingHint8: "{% t 'import.loading.hint8' %}",
        loadingHint9: "{% t 'import.loading.hint9' %}",
        loadingHint10: "{% t 'import.loading.hint10' %}",
        loadingHint11: "{% t 'import.loading.hint11' %}",
        loadingHint12: "{% t 'import.loading.hint12' %}",
        errorTitle: "{% t 'import.error.title' %}",
        errorDefault: "{% t 'import.error.default' %}",
        errorRetry: "{% t 'import.error.retry' %}",
        errorManualRequired: "{% t 'import.error.manual_required' %}",
        errorAutoMissing: "{% t 'import.error.auto_missing' %}",
        errorBadJson: "{% t 'import.error.bad_json' %}",
        errorPostOnly: "{% t 'import.error.post_only' %}",
        errorNeedLink: "{% t 'import.error.need_link' %}",
        errorStatusFailed: "{% t 'import.error.status_failed' %}",
        errorProcessing: "{% t 'import.error.processing' %}",
        errorDoneOpening: "{% t 'import.error.done_opening' %}",
        errorImportFailed: "{% t 'import.error.import_failed' %}",
        errorInvalidSession: "{% t 'import.error.invalid_session' %}",
        errorHeader: "{% t 'import.error.header' %}",
        errorTurnstileRequired: "Подтвердите проверку безопасности.",
        errorTurnstileFailed: "Проверка безопасности не пройдена. Попробуйте еще раз.",
        errorTurnstileUnavailable: "Cloudflare Turnstile недоступен в этой сети. Для локалки временно выключите TURNSTILE_ENABLED или используйте test keys.",
        copied: "{% t 'import.copied' %}",
        copy: "{% t 'import.copy' %}",
        copyError: "{% t 'import.copy_error' %}",
    };

    const FORM_STORAGE_KEY = "endfieldpass:import_form";
    const loadingHints = [
        i18n.loadingHint1,
        i18n.loadingHint2,
        i18n.loadingHint3,
        i18n.loadingHint4,
        i18n.loadingHint5,
        i18n.loadingHint6,
        i18n.loadingHint7,
        i18n.loadingHint8,
        i18n.loadingHint9,
        i18n.loadingHint10,
        i18n.loadingHint11,
        i18n.loadingHint12,
    ];

    const createSessionUrl = page.dataset.createSessionUrl;
    const statusTemplate = page.dataset.statusTemplate;
    const viewTemplate = page.dataset.viewTemplate;
    const pullsTemplate = page.dataset.pullsTemplate;
    const currentSessionId = page.dataset.currentSessionId;
    const turnstileEnabled = String(page.dataset.turnstileEnabled || "").trim().toLowerCase() === "true";

    const form = document.getElementById("importForm");
    const submitButton = document.getElementById("importSubmit");
    const importError = document.getElementById("importError");
    const loadingModal = document.getElementById("loadingModal");
    const loadingMessage = document.getElementById("loadingMessage");
    const loadingHint = document.getElementById("loadingHint");
    const loadingProgress = document.getElementById("loadingProgress");
    const loadingProgressTrack = document.getElementById("loadingProgressTrack");
    const loadingPercent = document.getElementById("loadingPercent");
    const loadingTopMediaWrap = document.getElementById("loadingTopMediaWrap");
    const loadingCard = loadingModal ? loadingModal.querySelector(".import-loading") : null;
    const loadingTopVideo = loadingModal ? loadingModal.querySelector(".loading-top-video") : null;
    const loadingTopFallback = loadingModal ? loadingModal.querySelector(".loading-top-fallback") : null;
    const importModeInput = document.getElementById("import_mode");
    const modeButtons = document.querySelectorAll("[data-import-mode]");
    const modePanels = document.querySelectorAll("[data-mode-panel]");
    const platformButtons = document.querySelectorAll("[data-platform-btn]");
    const platformPanels = document.querySelectorAll("[data-platform-panel]");
    const copyScriptButtons = document.querySelectorAll("[data-copy-script-btn]");

    const pageUrlInput = document.getElementById("page_url");
    const tokenInput = document.getElementById("token");
    const serverSelect = document.getElementById("server_id");
    const langSelect = document.getElementById("lang");
    const turnstileWidget = document.getElementById("turnstileWidget");

    let displayedProgress = 0;
    let targetProgress = 0;
    let actualProgress = 0;
    let progressAnimationFrame = null;
    let progressLastTimestamp = 0;
    let progressLoopActive = false;
    let lastServerProgressAt = 0;
    let hintInterval = null;
    let videoWatchdogInterval = null;
    let lastVideoTime = -1;
    let stalledVideoTicks = 0;
    const PROGRESS_EPSILON = 0.05;
    const PROGRESS_MIN_SPEED = 8;
    const PROGRESS_MAX_SPEED = 34;

    const buildSessionUrl = (template, sessionId) => template.replace("/0/", `/${sessionId}/`);

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
    const nowMs = () => (window.performance && typeof window.performance.now === "function" ? window.performance.now() : Date.now());

    const fakeAheadLimit = (progress) => {
        if (progress >= 98) return 0.8;
        if (progress >= 90) return 1.8;
        if (progress >= 75) return 3.2;
        if (progress >= 55) return 4.8;
        if (progress >= 30) return 6.0;
        return 7.2;
    };

    const fakeRatePerSecond = (progress) => {
        if (progress >= 98) return 0.12;
        if (progress >= 90) return 0.25;
        if (progress >= 75) return 0.45;
        if (progress >= 55) return 0.65;
        if (progress >= 30) return 0.85;
        return 1.05;
    };

    const refreshVisualTarget = (timestamp) => {
        if (actualProgress >= 100) {
            targetProgress = 100;
            return;
        }
        if (!lastServerProgressAt) {
            lastServerProgressAt = timestamp || nowMs();
        }

        const elapsedSeconds = Math.max(0, ((timestamp || nowMs()) - lastServerProgressAt) / 1000);
        const previewIncrement = Math.min(fakeAheadLimit(actualProgress), elapsedSeconds * fakeRatePerSecond(actualProgress));
        const previewTarget = Math.min(99.4, actualProgress + previewIncrement);
        targetProgress = Math.max(targetProgress, Math.max(actualProgress, previewTarget));
    };

    const updateTopMediaPosition = (progressValue = 0) => {
        if (!loadingTopMediaWrap || !loadingProgressTrack || !loadingCard) return;

        const trackRect = loadingProgressTrack.getBoundingClientRect();
        const cardRect = loadingCard.getBoundingClientRect();
        if (trackRect.width <= 0 || cardRect.width <= 0) return;

        const mediaWidth = loadingTopMediaWrap.offsetWidth || 0;
        const mediaHeight = loadingTopMediaWrap.offsetHeight || 0;

        const trackStartX = trackRect.left - cardRect.left;
        const rightEdgeX = trackStartX + trackRect.width;
        const left = clamp(rightEdgeX - mediaWidth + 62, 0, Math.max(0, cardRect.width - mediaWidth));
        const top = trackRect.top - cardRect.top - mediaHeight + 2;

        loadingTopMediaWrap.style.left = `${left}px`;
        loadingTopMediaWrap.style.top = `${Math.max(0, top)}px`;
    };

    const kickVideoPlayback = (hardReset = false) => {
        if (!loadingTopVideo) return;

        if (loadingTopFallback) loadingTopFallback.hidden = true;
        loadingTopVideo.hidden = false;

        if (hardReset) {
            try {
                loadingTopVideo.load();
            } catch (_) {}
        }

        const playPromise = loadingTopVideo.play();
        if (playPromise && typeof playPromise.catch === "function") {
            playPromise.catch(() => {
                if (loadingTopFallback) loadingTopFallback.hidden = false;
                loadingTopVideo.hidden = true;
            });
        }
    };

    const stopVideoWatchdog = () => {
        if (videoWatchdogInterval) {
            clearInterval(videoWatchdogInterval);
            videoWatchdogInterval = null;
        }
        lastVideoTime = -1;
        stalledVideoTicks = 0;
    };

    const startVideoWatchdog = () => {
        if (!loadingTopVideo) return;
        stopVideoWatchdog();

        kickVideoPlayback(false);
        videoWatchdogInterval = setInterval(() => {
            if (loadingModal.hidden) return;
            if (document.hidden) return;

            if (loadingTopVideo.readyState < 2) {
                kickVideoPlayback(true);
                return;
            }

            const currentTime = Number(loadingTopVideo.currentTime || 0);
            if (lastVideoTime >= 0 && currentTime <= lastVideoTime + 0.01) {
                stalledVideoTicks += 1;
            } else {
                stalledVideoTicks = 0;
            }
            lastVideoTime = currentTime;

            if (loadingTopVideo.paused || stalledVideoTicks >= 2) {
                stalledVideoTicks = 0;
                kickVideoPlayback(true);
            }
        }, 1200);
    };

    const animateProgress = (timestamp) => {
        if (!progressLastTimestamp) {
            progressLastTimestamp = timestamp;
        }
        const deltaSeconds = Math.min((timestamp - progressLastTimestamp) / 1000, 0.1);
        progressLastTimestamp = timestamp;
        if (progressLoopActive) {
            refreshVisualTarget(timestamp);
        }

        const diff = targetProgress - displayedProgress;
        if (diff <= PROGRESS_EPSILON) {
            displayedProgress = targetProgress;
        } else {
            const speed = clamp(diff * 6, PROGRESS_MIN_SPEED, PROGRESS_MAX_SPEED);
            displayedProgress = Math.min(targetProgress, displayedProgress + speed * deltaSeconds);
        }

        loadingProgress.style.width = `${displayedProgress}%`;
        loadingPercent.textContent = `${Math.round(displayedProgress)}%`;
        updateTopMediaPosition(displayedProgress);

        if (progressLoopActive || (targetProgress - displayedProgress) > PROGRESS_EPSILON) {
            progressAnimationFrame = window.requestAnimationFrame(animateProgress);
            return;
        }
        displayedProgress = targetProgress;
        loadingProgress.style.width = `${displayedProgress}%`;
        loadingPercent.textContent = `${Math.round(displayedProgress)}%`;
        updateTopMediaPosition(displayedProgress);
        progressAnimationFrame = null;
        progressLastTimestamp = 0;
    };

    const setProgress = (progress, message) => {
        const next = Math.max(0, Math.min(100, Number(progress) || 0));
        const previousActual = actualProgress;
        actualProgress = Math.max(actualProgress, next);
        if (actualProgress > previousActual + PROGRESS_EPSILON) {
            lastServerProgressAt = nowMs();
        }
        targetProgress = Math.max(targetProgress, actualProgress);
        if (actualProgress >= 100) {
            targetProgress = 100;
        }
        if (message) loadingMessage.textContent = message;
        if (!progressAnimationFrame) {
            progressAnimationFrame = window.requestAnimationFrame(animateProgress);
        }
    };

    const showError = (message, title = i18n.errorTitle) => {
        importError.hidden = false;
        importError.textContent = "";
        const titleNode = document.createElement("strong");
        titleNode.textContent = String(title || i18n.errorTitle);
        const messageNode = document.createElement("span");
        messageNode.textContent = String(message || i18n.errorDefault);
        importError.appendChild(titleNode);
        importError.appendChild(messageNode);
    };

    const hideError = () => {
        importError.hidden = true;
        importError.innerHTML = "";
    };

    const pickRandomHint = (previousHint = "") => {
        const pool = loadingHints.filter((hint) => String(hint || "").trim());
        if (!pool.length) return "";
        if (pool.length === 1) return pool[0];

        let candidate = pool[Math.floor(Math.random() * pool.length)];
        if (candidate === previousHint) {
            const alternatives = pool.filter((hint) => hint !== previousHint);
            candidate = alternatives[Math.floor(Math.random() * alternatives.length)] || candidate;
        }
        return candidate;
    };

    const runHintTicker = () => {
        stopHintTicker();
        let currentHint = pickRandomHint("");
        if (currentHint) loadingHint.textContent = currentHint;

        if (loadingHints.length < 2) return;
        hintInterval = setInterval(() => {
            currentHint = pickRandomHint(currentHint);
            if (currentHint) loadingHint.textContent = currentHint;
        }, 4500);
    };

    const stopHintTicker = () => {
        if (hintInterval) {
            clearInterval(hintInterval);
            hintInterval = null;
        }
    };

    const setLoadingState = (isLoading) => {
        const isManualMode = importModeInput.value === "manual";
        loadingModal.hidden = !isLoading;
        submitButton.disabled = isLoading;
        pageUrlInput.readOnly = isLoading;
        tokenInput.readOnly = isLoading;
        pageUrlInput.disabled = isLoading || isManualMode;
        tokenInput.disabled = isLoading || !isManualMode;
        serverSelect.disabled = isLoading || !isManualMode;
        langSelect.disabled = isLoading || !isManualMode;
        document.body.classList.toggle("modal-open", isLoading);

        if (isLoading) {
            progressLoopActive = true;
            window.requestAnimationFrame(() => updateTopMediaPosition(displayedProgress));
            startVideoWatchdog();
            if (!progressAnimationFrame) {
                progressAnimationFrame = window.requestAnimationFrame(animateProgress);
            }
        }

        if (!isLoading) {
            progressLoopActive = false;
            stopHintTicker();
            stopVideoWatchdog();
            if (progressAnimationFrame) {
                cancelAnimationFrame(progressAnimationFrame);
                progressAnimationFrame = null;
            }
            progressLastTimestamp = 0;
        }
    };

    const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    const applyMode = (mode) => {
        importModeInput.value = mode;
        modeButtons.forEach((button) => {
            button.classList.toggle("active", button.dataset.importMode === mode);
        });
        modePanels.forEach((panel) => {
            panel.hidden = panel.dataset.modePanel !== mode;
        });

        const isManual = mode === "manual";
        pageUrlInput.disabled = isManual;
        tokenInput.disabled = !isManual;
        serverSelect.disabled = !isManual;
        langSelect.disabled = !isManual;
    };

    const applyPlatform = (platform) => {
        platformButtons.forEach((button) => {
            const isActive = button.dataset.platformBtn === platform;
            button.classList.toggle("active", isActive);
            button.setAttribute("aria-selected", isActive ? "true" : "false");
        });
        platformPanels.forEach((panel) => {
            panel.hidden = panel.dataset.platformPanel !== platform;
        });
    };

    const detectPlatformFromSystem = () => {
        const nav = window.navigator || {};
        const uaDataPlatform = String(nav.userAgentData?.platform || "").toLowerCase();
        const platform = String(nav.platform || "").toLowerCase();
        const userAgent = String(nav.userAgent || "").toLowerCase();
        const maxTouchPoints = Number(nav.maxTouchPoints || 0);

        const source = `${uaDataPlatform} ${platform} ${userAgent}`;
        const isAndroid = source.includes("android");
        const isIphone = source.includes("iphone");
        const isIpad = source.includes("ipad") || (platform.includes("mac") && maxTouchPoints > 1);
        const isIos = isIphone || isIpad;
        const isWindows = source.includes("win");
        const isLinux = source.includes("linux") && !isAndroid;

        if (isAndroid) return "android";
        if (isIos) return "ios";
        if (isLinux) return "linux";
        if (isWindows) return "windows";
        return "windows";
    };

    const clearFieldErrors = () => {
        [pageUrlInput, tokenInput, serverSelect, langSelect].forEach((field) => {
            field.classList.remove("field-invalid");
        });
    };

    const markFieldErrors = (fields) => {
        fields.forEach((field) => {
            if (field) field.classList.add("field-invalid");
        });
    };

    const normalizeServerError = (rawMessage, mode) => {
        const text = String(rawMessage || "").trim();
        const lower = text.toLowerCase();

        if (!text) return i18n.errorRetry;
        if (lower.includes("missing token/server_id")) {
            if (mode === "manual") {
                return i18n.errorManualRequired;
            }
            return i18n.errorAutoMissing;
        }
        if (lower.includes("bad json")) {
            return i18n.errorBadJson;
        }
        if (lower.includes("post only")) {
            return i18n.errorPostOnly;
        }
        if (lower.includes("turnstile required")) {
            return i18n.errorTurnstileRequired;
        }
        if (lower.includes("turnstile failed")) {
            return i18n.errorTurnstileFailed;
        }
        return text;
    };

    const getTurnstileToken = () => {
        if (!turnstileEnabled) return "";
        if (window.turnstile && turnstileWidget) {
            try {
                return String(window.turnstile.getResponse(turnstileWidget) || "").trim();
            } catch (_) {}
        }
        const fallbackInput = form.querySelector('input[name="cf-turnstile-response"]');
        return String(fallbackInput?.value || "").trim();
    };

    const resetTurnstile = () => {
        if (!turnstileEnabled || !window.turnstile || !turnstileWidget) return;
        try {
            window.turnstile.reset(turnstileWidget);
        } catch (_) {}
    };

    const validateImportForm = (mode) => {
        clearFieldErrors();
        if (mode === "manual") {
            const invalidFields = [];
            if (!tokenInput.value.trim()) invalidFields.push(tokenInput);
            if (!serverSelect.value.trim()) invalidFields.push(serverSelect);
            if (invalidFields.length) {
                markFieldErrors(invalidFields);
                return i18n.errorManualRequired;
            }
        } else {
            const pageUrl = pageUrlInput.value.trim();
            if (!pageUrl) {
                markFieldErrors([pageUrlInput]);
                return i18n.errorNeedLink;
            }
        }

        return "";
    };

    const saveFormState = () => {
        const activePlatform = document.querySelector("[data-platform-btn].active");
        const payload = {
            mode: importModeInput.value,
            platform: activePlatform ? activePlatform.dataset.platformBtn : "windows",
            token: tokenInput.value,
            server_id: serverSelect.value,
            lang: langSelect.value,
        };
        localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(payload));
    };

    const restoreFormState = () => {
        try {
            const raw = localStorage.getItem(FORM_STORAGE_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (data.mode === "manual" || data.mode === "auto") {
                applyMode(data.mode);
            }
            if (data.platform === "windows" || data.platform === "linux" || data.platform === "android" || data.platform === "ios") {
                applyPlatform(data.platform);
            }
            if (!tokenInput.value && data.token) tokenInput.value = data.token;
            if (data.server_id) serverSelect.value = data.server_id;
            if (data.lang) langSelect.value = data.lang;
        } catch (_) {}
    };

    const persistImportedSession = async (sessionId, sourcePayload) => {
        const pullsUrl = buildSessionUrl(pullsTemplate, sessionId);
        const pullsResponse = await fetch(pullsUrl, { cache: "no-store" });
        if (!pullsResponse.ok) {
            throw new Error(i18n.errorImportFailed);
        }
        const pullsPayload = await pullsResponse.json();
        const pulls = Array.isArray(pullsPayload.items) ? pullsPayload.items : [];
        if (!window.endfieldPassHistory || typeof window.endfieldPassHistory.upsertImportedSession !== "function") {
            return;
        }
        window.endfieldPassHistory.upsertImportedSession({
            server_id: sourcePayload?.server_id || serverSelect.value || "3",
            lang: sourcePayload?.lang || langSelect.value || "ru-ru",
            page_url: sourcePayload?.page_url || pageUrlInput.value || "",
            pulls,
        });
        if (typeof window.endfieldPassHistory.syncWithCloud === "function") {
            await window.endfieldPassHistory.syncWithCloud({ force: true, preferPush: true });
        }
    };

    const pollImportStatus = async (sessionId, sourcePayload) => {
        const statusUrl = buildSessionUrl(statusTemplate, sessionId);
        while (true) {
            const response = await fetch(statusUrl, { cache: "no-store" });
            if (!response.ok) throw new Error(i18n.errorStatusFailed);
            const payload = await response.json();

            if (Number.isFinite(payload.progress)) {
                setProgress(payload.progress, payload.message || i18n.errorProcessing);
            } else if (payload.message) {
                loadingMessage.textContent = payload.message;
            }

            if (payload.status === "done") {
                setProgress(100, i18n.errorDoneOpening);
                await persistImportedSession(sessionId, sourcePayload);
                window.location.href = buildSessionUrl(viewTemplate, sessionId);
                return;
            }

            if (payload.status === "error") {
                throw new Error(payload.error || i18n.errorImportFailed);
            }
            await sleep(900);
        }
    };

    const copyScriptToClipboard = async (button) => {
        const targetId = String(button?.dataset.copyScriptTarget || "");
        const sourceNode = targetId ? document.getElementById(targetId) : null;
        const text = sourceNode ? (sourceNode.textContent || "") : "";
        if (!text) return;
        try {
            await navigator.clipboard.writeText(text);
            button.textContent = i18n.copied;
            setTimeout(() => {
                button.textContent = i18n.copy;
            }, 1400);
        } catch (_) {
            button.textContent = i18n.copyError;
            setTimeout(() => {
                button.textContent = i18n.copy;
            }, 1400);
        }
    };

    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        hideError();
        clearFieldErrors();
        saveFormState();

        const mode = importModeInput.value;
        const validationMessage = validateImportForm(mode);
        if (validationMessage) {
            showError(validationMessage);
            return;
        }

        if (turnstileEnabled && (!window.turnstile || !turnstileWidget)) {
            showError(i18n.errorTurnstileUnavailable);
            return;
        }

        const turnstileToken = getTurnstileToken();
        if (turnstileEnabled && !turnstileToken) {
            showError(i18n.errorTurnstileRequired);
            return;
        }

        displayedProgress = 0;
        targetProgress = 0;
        actualProgress = 0;
        progressLastTimestamp = 0;
        lastServerProgressAt = nowMs();
        loadingProgress.style.width = "0%";
        loadingPercent.textContent = "0%";
        updateTopMediaPosition(0);
        loadingMessage.textContent = i18n.loadingPrepare;
        runHintTicker();
        setLoadingState(true);
        setProgress(2, i18n.loadingPrepare);

        const payload = mode === "manual"
            ? {
                token: tokenInput.value.trim(),
                server_id: serverSelect.value.trim(),
                lang: langSelect.value.trim(),
                page_url: "",
                turnstile_token: turnstileToken,
            }
            : {
                page_url: pageUrlInput.value.trim(),
                token: "",
                server_id: "",
                lang: "",
                turnstile_token: turnstileToken,
            };

        try {
            const response = await fetch(createSessionUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const text = await response.text();
                resetTurnstile();
                throw new Error(normalizeServerError(text, mode));
            }

            const result = await response.json();
            if (!result.session_id) {
                throw new Error(i18n.errorInvalidSession);
            }

            await pollImportStatus(result.session_id, payload);
        } catch (error) {
            setLoadingState(false);
            resetTurnstile();
            showError(normalizeServerError(error.message, mode), i18n.errorHeader);
        }
    });

    modeButtons.forEach((button) => {
        button.addEventListener("click", () => {
            applyMode(button.dataset.importMode);
            clearFieldErrors();
            hideError();
            saveFormState();
        });
    });

    platformButtons.forEach((button) => {
        button.addEventListener("click", () => {
            applyPlatform(button.dataset.platformBtn);
            saveFormState();
        });
    });

    copyScriptButtons.forEach((button) => {
        button.addEventListener("click", () => {
            copyScriptToClipboard(button);
        });
    });

    [pageUrlInput, tokenInput, serverSelect, langSelect].forEach((field) => {
        field.addEventListener("change", saveFormState);
        field.addEventListener("input", saveFormState);
        field.addEventListener("input", () => field.classList.remove("field-invalid"));
    });

    if (loadingTopVideo) {
        ["stalled", "waiting", "suspend", "emptied", "error"].forEach((eventName) => {
            loadingTopVideo.addEventListener(eventName, () => {
                if (!loadingModal.hidden) kickVideoPlayback(true);
            });
        });
        loadingTopVideo.addEventListener("pause", () => {
            if (!loadingModal.hidden) kickVideoPlayback(false);
        });
        loadingTopVideo.addEventListener("ended", () => {
            loadingTopVideo.currentTime = 0;
            if (!loadingModal.hidden) kickVideoPlayback(false);
        });
    }

    window.addEventListener("resize", () => {
        updateTopMediaPosition(displayedProgress);
    });
    document.addEventListener("visibilitychange", () => {
        if (!document.hidden && !loadingModal.hidden) {
            kickVideoPlayback(false);
        }
    });

    applyMode("auto");
    applyPlatform(detectPlatformFromSystem());
    restoreFormState();
    applyPlatform(detectPlatformFromSystem());
    if (!currentSessionId) {
        pageUrlInput.value = "";
    }

    if (!importError.hidden && importError.textContent.trim()) {
        const message = normalizeServerError(importError.textContent.trim(), importModeInput.value);
        showError(message, i18n.errorHeader);
    }
})();
</script>
{% endblock %}
